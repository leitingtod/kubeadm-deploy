- hosts:
  - ftp
  tasks:
  # deprecated
  - name: 上传共享文件
    become: yes
    copy: src={{ item }} dest=/srv/ftp/{{ item.split('/')[-1] }} mode=0644
    with_fileglob:
    - roles/prepare/files/alias.rc
    - bin/docker-compose-*
    - bin/helm-*
    tags: ftp

  - name: prepare charts dirs
    become: yes
    file: name={{ item }} state=directory
    with_items:
    - /opt/helm-repo/charts
    tags: charts

  - name: 上传 docker-compose.yaml
    become: yes
    copy: src={{ item }} dest=/opt/helm-repo/{{ item.split('/')[-1] }} mode=0644
    with_fileglob:
    - manifests/helm/repository/*
    tags: charts

  - name: 上传 qycloud chart
    become: yes
    copy: src=manifests/qycloud dest=/opt/helm-repo/charts mode=0644
    tags: charts

  - name: 上传 helm
    become: yes
    copy: src=bin/helm-v2.8.1 dest=/usr/local/bin/helm mode=0755
    tags: charts

  - name: 启动 Charts Nginx Server
    become: yes
    shell: export HELM_HOME=/opt/helm-repo/.helm && cd /opt/helm-repo/charts && helm init --client-only --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts && helm package qycloud && rm -rf qycloud && cd /opt/helm-repo && helm repo index charts --url http://charts.aysaas.com:8079 && docker-compose down && docker-compose up -d
    tags: charts

- hosts:
  - ansible-ops
  tasks:
  - name: 同步共享文件
    copy: src={{ item }} dest=~/program/docker-dev/bastion/{{ item.split('/')[-1] }} mode=0644
    with_fileglob:
    - roles/prepare/files/alias.rc
    - bin/*.conf
    - bin/helm-*
    tags: local
