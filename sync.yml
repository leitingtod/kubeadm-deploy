- hosts:
  - kube-master
  tasks:
  - name: fetch kubeconfig
    become: yes
    fetch:
      src: /etc/kubernetes/admin.conf
      dest: bin/{{ NODE_IP }}.admin.conf
      flat: yes
    tags: fetch-kubeconfig

- hosts:
  - ansible-ops
  tasks:
  - name: sync config files to bastion
    copy: src={{ item }} dest={{ playbook_dir.replace('kubeadm-deploy', '') }}docker-dev/bastion/{{ item.split('/')[-1] }} mode=0644 owner=anyuan group=anyuan
    with_fileglob:
    - roles/prepare/files/alias.rc
    - bin/*.conf
    - bin/helm-*
    tags: local

- hosts:
  - ftp
  tasks:
  - name: sync config files to ftp
    become: yes
    copy: src={{ item }} dest=/srv/ftp/{{ item.split('/')[-1] }} mode=0644
    with_fileglob:
    - roles/prepare/files/alias.rc
    - bin/docker-compose-*
    - bin/*.conf
    - bin/helm-*
    tags: ftp

  - name: update to latest version
    become: yes
    shell: cd /srv/ftp && mv helm-* helm && mv docker-compose-* docker-compose
    tags: ftp