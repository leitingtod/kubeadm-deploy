- name: 安装 kubeadm kubectl kubelet
  become: yes
  apt: name={{ item }} state=present
  with_items:
  - kubeadm
  - kubectl
  - kubelet
  - kubernetes-cni

- name: 更换 kubelet pod-infra-container-image
  become: yes
  lineinfile:
    dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    insertbefore: '^ExecStart=$'
    line: 'Environment="KUBELET_EXTRA_ARGS=--pod-infra-container-image=dockerhub.aysaas.com/kubernetes/pause-amd64:3.1"'
    state: present

- name: Install nfs-clinet for nsf-storage
  become: yes
  apt: name={{ item }} state=present
  with_items:
  - nfs-common
  tags: install-nfs

- name: Disable Swap | /etc/fstab
  become: yes
  replace:
    dest: /etc/fstab
    regexp: '(^[^#].*swap.*sw.*$)'
    replace: '# \1'
    backup: yes
  tags: fstab

- name: Disable Swap | /etc/sysctl.d/k8s.conf
  become: yes
  lineinfile:
    dest: /etc/sysctl.d/k8s.conf
    line: 'vm.swappiness=0'
    create: yes
    state: present
  tags: k8s-conf

- name: Disable Swap | sysctl
  become: yes
  shell: sysctl -p /etc/sysctl.d/k8s.conf && swapoff -a
  tags: swapoff