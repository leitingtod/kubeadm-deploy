#- name: Install the package "python 2.7"
#  sudo: yes
#  raw: sudo apt-get update && sudo apt-get -y install python-2.7

- name: Set authorized key for user ubuntu copying it from current user
  authorized_key:
    user: anyuan
    state: present
    key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"

## Kubeadm don't use cfssl
#- name: Check CFSSL exists
#  become: yes
#  stat:
#    path: "/usr/local/bin/cfssl"
#  register: cfssl_stat

#- name: 安装 CFSSL
#  become: yes
#  copy: src=bin/{{ item }} dest=/usr/local/bin/{{ item }} mode=0755
#  with_items:
#  - cfssl
#  - cfssl-certinfo
#  - cfssljson
#  when: cfssl_stat.stat.exists == False

- name: 更换 APT 源为 USTC
  become: yes
  copy: src=sources.list-16.04 dest=/etc/apt/sources.list mode=0644
  tags: config

- name: 添加 USTC Public Key
  become: yes
  shell: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3746C208A7317B0F

- name: 设置常用命令别名
  become: yes
  copy: src=alias.rc dest=/etc/profile.d/alias.sh mode=0644
  tags: config

- name: 设置 gitconfig
  become: yes
  copy: src=gitconfig dest=/root/.gitconfig mode=0644
  tags: config

- name: Disable Swap | /etc/fstab
  become: yes
  replace:
    dest: /etc/fstab
    regexp: '(^[^#].*swap.*sw.*$)'
    replace: '# \1'
    backup: yes
  tags: fstab

- name: Disable Swap | /etc/sysctl.d/k8s.conf
  become: yes
  lineinfile:
    dest: /etc/sysctl.d/k8s.conf
    line: 'vm.swappiness=0'
    create: yes
    state: present
  tags: k8s-conf

- name: Disable Swap | sysctl
  become: yes
  shell: sysctl -p /etc/sysctl.d/k8s.conf && swapoff -a
  tags: swapoff

- import_tasks: hostname.yml


